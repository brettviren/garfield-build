CDECK  ID>, EFCMAP.
       SUBROUTINE EFCMAP(Z,WW,WD)
*-----------------------------------------------------------------------
*   EFCMAP - Maps a the interior part of a regular in the unit circle.
*   Variables: Z     - point to be mapped
*              W     - the image of Z
*              WD    - derivative of the mapping at Z
*              CC1   - coefficients for expansion around centre
*              CC2   - coefficients for expansion around cornre
*   (Last changed on 19/ 2/94.)
*-----------------------------------------------------------------------
       INTEGER MXWIRE,MXSW,MXLIST,MXCHA,MXGRID,MXMATT,MXPOLE,MX3D,
     -         MXPSTR,
     -         MXPAIR,MXPART,MXFOUR,MXCLUS,
     -         MXLINE,MXEQUT,
     -         MXRECL,MXINCH,MXWORD,MXCHAR,MXNAME,MXLUN,
     -         MXINS,MXREG,MXARG,MXCONS,MXVAR,MXALGE,
     -         MXZERO,MXSTCK,MXFPNT,MXFPAR,MXWKLS,
     -         MXHLEV,MXHLRL,MXSUBT,
     -         MXDLVL,MXILVL,MXDLIN,
     -         MXHIST,MXFRAC,MXBANG,MXBTAB,
     -         MXEXG,MXIOG,MXCSG,
     -         MXORIA,
     -         MXMAT,MXEMAT,MXMDIM,
     -         MXSHOT,MXZPAR,
     -         MXMAP,MXEPS,MXWMAP,MXSOLI,MXSBUF,
     -         MXPLAN,MXPOIN,MXEDGE,
     -         MXMCA
       PARAMETER (MXWIRE=  2000,MXSW  =  200)
       PARAMETER (MXMATT=    10)
       PARAMETER (MX3D  =   100)
       PARAMETER (MXPOLE=    10)
       PARAMETER (MXPSTR=   100)
       PARAMETER (MXLIST=  1000)
       PARAMETER (MXHIST=   200, MXCHA = MXLIST/2)
       PARAMETER (MXGRID=    50)
       PARAMETER (MXNAME=   200, MXLUN =    30)
       PARAMETER (MXCLUS=   500, MXPAIR=  2000, MXPART= 10000)
       PARAMETER (MXLINE=   150, MXEQUT=    50)
       PARAMETER (MXFOUR=    16)
       PARAMETER (MXRECL= 10000)
       PARAMETER (MXINCH=  2000, MXWORD=   200, MXCHAR=MXINCH)
       PARAMETER (MXINS =  1000, MXREG =   500, MXCONS=  -500,
     -            MXVAR =   500, MXALGE=   500, MXARG =   100)
       PARAMETER (MXMAT =   500, MXEMAT=200000, MXMDIM=   10)
       PARAMETER (MXZERO=MXWIRE)
       PARAMETER (MXSTCK=     5)
       PARAMETER (MXFPNT= 20000, MXFPAR=    10)
       PARAMETER (MXWKLS=    10)
       PARAMETER (MXHLEV=     9, MXSUBT=   200, MXHLRL=  860)
       PARAMETER (MXDLVL=    10, MXILVL=    20, MXDLIN= 2500)
       PARAMETER (MXFRAC=    13)
       PARAMETER (MXBANG=    20, MXBTAB=    25)
       PARAMETER (MXEXG =    50, MXIOG =    10, MXCSG =  200)
       PARAMETER (MXORIA=  1000)
       PARAMETER (MXSHOT=    10, MXZPAR=4*MXSHOT+2)
       PARAMETER (MXMAP =350000,MXEPS =   10)
       PARAMETER (MXWMAP=     5)
       PARAMETER (MXSOLI=  1000)
       PARAMETER (MXPLAN= 50000, MXPOIN=100000,MXEDGE=100)
       PARAMETER (MXSBUF= 20000)
       PARAMETER (MXMCA = 50000)
*   The parameter MXNBMC must equal MXGNAM (sequence MAGBPARM) !
       INTEGER MXNBMC
       PARAMETER(MXNBMC=60)
       CHARACTER*80 CELLID
       CHARACTER*3 TYPE
       CHARACTER WIRTYP(MXWIRE),PLATYP(5),
     -      PSLAB1(5,MXPSTR),PSLAB2(5,MXPSTR)
       LOGICAL YNPLAN(4),PERX,PERY,PERZ,YNPLAX,YNPLAY,YNMATX,YNMATY,
     -      POLAR,TUBE,PERMX,PERMY,PERMZ,PERAX,PERAY,PERAZ,
     -      PERRX,PERRY,PERRZ,CNALSO(MXWIRE),LBGFMP,CELSET,LDIPOL,
     -      BEMSET
       INTEGER INDSW(MXWIRE),NWIRE,NSW,ICTYPE,MODE,NTUBE,MTUBE,
     -      NXMATT,NYMATT,N3D,NTERMB,NTERMP,IENBGF,
     -      INDPLA(5),NPSTR1(5),NPSTR2(5),
     -      INDST1(5,MXPSTR),INDST2(5,MXPSTR)
       REAL X(MXWIRE),Y(MXWIRE),V(MXWIRE),E(MXWIRE),D(MXWIRE),W(MXWIRE),
     -      U(MXWIRE),DENS(MXWIRE),
     -      COSPH2(MXWIRE),SINPH2(MXWIRE),AMP2(MXWIRE),
     -      COPLAN(4),VTPLAN(4),XMATT(MXMATT,5),YMATT(MXMATT,5),
     -      X3D(MX3D),Y3D(MX3D),Z3D(MX3D),E3D(MX3D),
     -      DOWN(3),PLSTR1(5,MXPSTR,3),PLSTR2(5,MXPSTR,3),
     -      COTUBE,VTTUBE,B2SIN(MXWIRE),P1,P2,C1,
     -      XMIN,YMIN,ZMIN,XMAX,YMAX,ZMAX,VMIN,VMAX,
     -      COPLAX,COPLAY,COMATX,COMATY,
     -      CORVTA,CORVTB,CORVTC,V0,SX,SY,SZ,
     -      KAPPA
       COMPLEX ZMULT,WMAP(MXWIRE)
       COMMON /CELDAT/ ZMULT,WMAP,X,Y,V,E,D,W,U,DENS,
     -      COSPH2,SINPH2,AMP2,
     -      B2SIN,COPLAN,VTPLAN,XMATT,YMATT,X3D,Y3D,Z3D,E3D,DOWN,
     -      PLSTR1,PLSTR2,
     -      XMIN,YMIN,ZMIN,XMAX,YMAX,ZMAX,VMIN,VMAX,
     -      COPLAX,COPLAY,COMATX,COMATY,COTUBE,VTTUBE,
     -      CORVTA,CORVTB,CORVTC,V0,SX,SY,SZ,P1,P2,C1,KAPPA,
     -      INDSW,NWIRE,NSW,ICTYPE,MODE,NXMATT,NYMATT,NTUBE,MTUBE,
     -      N3D,NTERMB,NTERMP,IENBGF,
     -      INDPLA,NPSTR1,NPSTR2,INDST1,INDST2,
     -      YNPLAN,YNPLAX,YNPLAY,YNMATX,YNMATY,PERX,PERY,PERZ,
     -      POLAR,TUBE,PERMX,PERMY,PERMZ,PERAX,PERAY,PERAZ,CNALSO,
     -      PERRX,PERRY,PERRZ,LBGFMP,CELSET,LDIPOL,BEMSET
       COMMON /CELCHR/ CELLID,WIRTYP,PLATYP,TYPE,PSLAB1,PSLAB2
       COMPLEX ICONS
       REAL PI,CLOG2,EPS0,ECHARG,EMASS,CLIGHT,MEV2KG,BOLTZ,GRAV
       PARAMETER (PI=3.141592653589793238,
     -      CLOG2=0.693147180559945309417,
     -      ICONS=(0.0,1.0),
     -      EPS0=8.854187817E-14,
     -      ECHARG=1.60217733E-19,
     -      EMASS=9.1093897E-31,
     -      GRAV=9.80665,
     -      CLIGHT=2.99792458E4,
     -      MEV2KG = 1.782661845E-30,
     -      BOLTZ=1.380658E-23)
       COMPLEX Z,ZZ,WW,WSUM,WD,WDSUM,ZTERM
       REAL CC1(0:15,3:8),CC2(0:15,3:8)
       INTEGER NTERM1(3:8),NTERM2(3:8)
*** Triangle: coefficients for centre and corner expansion.
       DATA (CC1(I,3),I=0,15) /
     -      0.1000000000E+01, -.1666666865E+00, 0.3174602985E-01,
     -      -.5731921643E-02, 0.1040112227E-02, -.1886279933E-03,
     -      0.3421107249E-04, -.6204730198E-05, 0.1125329618E-05,
     -      -.2040969207E-06, 0.3701631357E-07, -.6713513301E-08,
     -      0.1217605794E-08, -.2208327132E-09, 0.4005162868E-10,
     -      -.7264017512E-11/
       DATA (CC2(I,3),I=0,15) /
     -      0.3333333135E+00, -.5555555597E-01, 0.1014109328E-01,
     -      -.1837154618E-02, 0.3332451452E-03, -.6043842586E-04,
     -      0.1096152027E-04, -.1988050826E-05, 0.3605655365E-06,
     -      -.6539443120E-07, 0.1186035448E-07, -.2151069323E-08,
     -      0.3901317047E-09, -.7075676156E-10, 0.1283289534E-10,
     -      -.2327455936E-11/
*** Square: coefficients for centre and corner expansion.
       DATA (CC1(I,4),I=0,15) /
     -      0.1000000000E+01, -.1000000238E+00, 0.8333332837E-02,
     -      -.7051283028E-03, 0.5967194738E-04, -.5049648280E-05,
     -      0.4273189802E-06, -.3616123934E-07, 0.3060091514E-08,
     -      -.2589557457E-09, 0.2191374859E-10, -.1854418528E-11,
     -      0.1569274224E-12, -.1327975205E-13, 0.1123779363E-14,
     -      -.9509817570E-16/
       DATA (CC2(I,4),I=0,15) /
     -      0.1000000000E+01, -.5000000000E+00, 0.3000000119E+00,
     -      -.1750000119E+00, 0.1016666889E+00, -.5916666612E-01,
     -      0.3442307562E-01, -.2002724260E-01, 0.1165192947E-01,
     -      -.6779119372E-02, 0.3944106400E-02, -.2294691978E-02,
     -      0.1335057430E-02, -.7767395582E-03, 0.4519091453E-03,
     -      -.2629216760E-03/
*** Pentagon: coefficients for centre and corner expansion.
       DATA (CC1(I,5),I=0,15) /
     -      0.1000000000E+01, -.6666666269E-01, 0.1212121220E-02,
     -      -.2626262140E-03, -.3322110570E-04, -.9413293810E-05,
     -      -.2570029210E-05, -.7695705904E-06, -.2422486887E-06,
     -      -.7945993730E-07, -.2691839640E-07, -.9361642128E-08,
     -      -.3327319087E-08, -.1204430555E-08, -.4428404310E-09,
     -      -.1650302672E-09/
       DATA (CC2(I,5),I=0,15) /
     -      0.1248050690E+01, -.7788147926E+00, 0.6355384588E+00,
     -      -.4899077415E+00, 0.3713272810E+00, -.2838423252E+00,
     -      0.2174729109E+00, -.1663445234E+00, 0.1271933913E+00,
     -      -.9728997946E-01, 0.7442557812E-01, -.5692918226E-01,
     -      0.4354400188E-01, -.3330700099E-01, 0.2547712997E-01,
     -      -.1948769018E-01/
*** Hexagon: coefficients for centre and corner expansion.
       DATA (CC1(I,6),I=0,15) /
     -      0.1000000000E+01, -.4761904851E-01, -.1221001148E-02,
     -      -.3753788769E-03, -.9415557724E-04, -.2862767724E-04,
     -      -.9587882232E-05, -.3441659828E-05, -.1299798896E-05,
     -      -.5103651119E-06, -.2066504408E-06, -.8578405186E-07,
     -      -.3635090096E-07, -.1567239494E-07, -.6857355572E-08,
     -      -.3038770346E-08/
       DATA (CC2(I,6),I=0,15) /
     -      0.1333333015E+01, -.8888888955E+00, 0.8395061493E+00,
     -      -.7242798209E+00, 0.6016069055E+00, -.5107235312E+00,
     -      0.4393203855E+00, -.3745460510E+00, 0.3175755739E+00,
     -      -.2703750730E+00, 0.2308617830E+00, -.1966916919E+00,
     -      0.1672732830E+00, -.1424439549E+00, 0.1214511395E+00,
     -      -.1034612656E+00/
*** Heptagon: coefficients for centre and corner expansion.
       DATA (CC1(I,7),I=0,15) /
     -      0.1000000000E+01, -.3571428731E-01, -.2040816238E-02,
     -      -.4936389159E-03, -.1446709794E-03, -.4963850370E-04,
     -      -.1877940667E-04, -.7600909157E-05, -.3232265954E-05,
     -      -.1427365532E-05, -.6493634714E-06, -.3026190711E-06,
     -      -.1438593245E-06, -.6953911225E-07, -.3409525462E-07,
     -      -.1692310647E-07/
       DATA (CC2(I,7),I=0,15) /
     -      0.1359752655E+01, -.9244638681E+00, 0.9593217969E+00,
     -      -.8771237731E+00, 0.7490229011E+00, -.6677658558E+00,
     -      0.6196745634E+00, -.5591596961E+00, 0.4905325770E+00,
     -      -.4393517375E+00, 0.4029803872E+00, -.3631100059E+00,
     -      0.3199430704E+00, -.2866140604E+00, 0.2627358437E+00,
     -      -.2368256450E+00/
*** Octagon: coefficients for centre and corner expansion.
       DATA (CC1(I,8),I=0,15) /
     -      0.1000000000E+01, -.2777777612E-01, -.2246732125E-02,
     -      -.5571441725E-03, -.1790652314E-03, -.6708275760E-04,
     -      -.2766949183E-04, -.1219387286E-04, -.5640039490E-05,
     -      -.2706697160E-05, -.1337270078E-05, -.6763995657E-06,
     -      -.3488264610E-06, -.1828456675E-06, -.9718036154E-07,
     -      -.5227070332E-07/
       DATA (CC2(I,8),I=0,15) /
     -      0.1362840652E+01, -.9286670089E+00, 0.1035511017E+01,
     -      -.9800255299E+00, 0.8315343261E+00, -.7592730522E+00,
     -      0.7612683773E+00, -.7132136226E+00, 0.6074471474E+00,
     -      -.5554352999E+00, 0.5699443221E+00, -.5357525349E+00,
     -      0.4329345822E+00, -.3916820884E+00, 0.4401986003E+00,
     -      -.4197303057E+00/
*** Number of terms in each expansion.
       DATA (NTERM1(I),I=3,8) /6*15/
       DATA (NTERM2(I),I=3,8) /6*15/
*** Z coincides with the centre.
       IF(Z.EQ.0)THEN
*   Results are trivial.
            WW=0
            WD=KAPPA
*** Z is close to the centre.
       ELSEIF(ABS(Z).LT.0.75)THEN
*   Series expansion.
            ZTERM=(KAPPA*Z)**NTUBE
            WDSUM=0.0
            WSUM=CC1(NTERM1(NTUBE),NTUBE)
            DO 10 I=NTERM1(NTUBE)-1,0,-1
            WDSUM=WSUM+ZTERM*WDSUM
            WSUM=CC1(I,NTUBE)+ZTERM*WSUM
10          CONTINUE
*   Return the results.
            WW=KAPPA*Z*WSUM
            WD=KAPPA*(WSUM+NTUBE*ZTERM*WDSUM)
*** Z is close to the edge.
       ELSE
*   First rotate Z nearest to 1.
            AROT=-2*PI*NINT(0.5*ATAN2(AIMAG(Z),REAL(Z))*NTUBE/PI)/
     -           REAL(NTUBE)
            ZZ=Z*CMPLX(COS(AROT),SIN(AROT))
*   Expand in a series.
            ZTERM=(KAPPA*(1-ZZ))**(REAL(NTUBE)/REAL(NTUBE-2))
            WDSUM=0
            WSUM=CC2(NTERM2(NTUBE),NTUBE)
            DO 20 I=NTERM2(NTUBE)-1,0,-1
            WDSUM=WSUM+ZTERM*WDSUM
            WSUM=CC2(I,NTUBE)+ZTERM*WSUM
20          CONTINUE
*   And return the results.
            WW=CMPLX(COS(AROT),-SIN(AROT))*(1-ZTERM*WSUM)
            WD=REAL(NTUBE)*KAPPA*(KAPPA*(1-ZZ))**(2.0/REAL(NTUBE-2))*
     -           (WSUM+ZTERM*WDSUM)/REAL(NTUBE-2)
       ENDIF
       END
